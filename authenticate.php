<?php
require_once('fixString.php');
session_start();

if (isset($_POST['username']) && isset($_POST['password'])) {	
	$con = mysqli_connect("localhost", 'root', '', 'db' );
	$un =  mysql_entities_fix_string($con, $_POST['username']);
	$pw =  mysql_entities_fix_string($con, $_POST['password']);
	if(authenticate($con,$un,$pw)) {
		$_SESSION['username']= $un;
		$_SESSION['ip']= $_SERVER['REMOTE_ADDR'];
		$_SESSION['ua']=$_SERVER['HTTP_USER_AGENT'];
		$_SESSION['check'] = hash('ripemd128', $_SERVER['REMOTE_ADDR'] .
		$_SERVER['HTTP_USER_AGENT']);
	
		if(checkAdmin($con,$un)) {
			$_SESSION['admin'] = "Y";
			$admin = $_SESSION['admin'];
		} 
		header('Location: final.php');
		
	} else {
		echo "incorrect login information";
	}	
} 


//compares user login with database accounts
function authenticate($con, $un, $pw) {
	$query = "select * from users where `username` = '$un'";
	$result = mysqli_query($con, $query);
	$numRows= mysqli_num_rows($result);
			if($numRows>0) {
				//theres a user
				$row = mysqli_fetch_assoc($result);
				$salt1 = $row["salt1"];
				$salt2=$row["salt2"];
				$checkPw = hash('ripemd128', "$salt1$pw$salt2");
				
				
				if($checkPw==$row["password"]) {
				return true;
				} else {
					return false;
				}
			} else {
				//no user 
				return false;
			}
}

//check if the user is an admin
function checkAdmin($con,$un) {
	$query = "select * from users where `username` = '$un'";
	$result = mysqli_query($con, $query);
	$row = mysqli_fetch_assoc($result);
	$adminStatus = $row["admin"];
	if($adminStatus=="Y") {
		return true;
		} else {
		return false;
		}
	} 



	
?>