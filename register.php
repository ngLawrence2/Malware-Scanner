<?php 
 require_once('fixString.php');
echo <<<_END
<script src = "validate.js"></script>
<div class ="form" style= text-align:center>
	<form method = "post" action = "register.php" onsubmit="return validate(this)" >
		User Name: <input type = "text" name ="username"> <br><br>
		Password: <input type = "password" name = "password"> <br><br>
	<input type = "submit" value = "register">
	</form>
	</div>
_END;

$username =  $password = "";

if(isset($_POST['username']))
	$username = fix_string($_POST['username']);
if(isset($_POST['password']))
	$password = fix_string($_POST['password']);

$fail = validate_username($username, 8);
$fail .= validate_password($password,10);


$con = mysqli_connect("localhost", 'root', '', 'db' );
	if (mysqli_connect_errno()) {
		echo "Failed to connect to MySQL: " . mysqli_connect_error();
	} 
	if ( !empty( $_POST["username"] ) && !empty( $_POST["password"] ) && strcasecmp($fail, "") == 0) {
    // Field sent
	$username = $_POST["username"];
	$pw = $_POST["password"];
	$username = mysql_entities_fix_string($con, $username);
	$pw = mysql_entities_fix_string($con, $pw);
	createUser($con, $username, $pw);
} else {
	echo "please type in account information";
	
}

//deletes any slashes in a string
function fix_string($string) {
	if(get_magic_quotes_gpc()) $string  = stripslashes($string);
	return htmlentities($string);
}
	
	//inserts user into database
	function createUSer($con, $username, $pw) {
		$query = "select username from users where `username` = '$username'";
		$salt1 = createSalt();
		$salt2= createSalt();
		$password = hash('ripemd128', "$salt1$pw$salt2");
		$result = mysqli_query($con, $query);
		$numRows= mysqli_num_rows($result);
			if($numRows>0) {
				echo "Please choose another username";
			} else {
				$query = "insert into `users`(username, password, salt1, salt2, admin) 
				values ('$username','$password', '$salt1', '$salt2', 'N')";
				$result = mysqli_query($con, $query);
				echo "Account Created" . "<br>";
				echo "Please <a href='login.html'>click here</a> to log in.";
			}
		}
	
	//creates random salt for each account created
	function createSalt() {
		$characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
		 $charactersLength = strlen($characters);
		$salt = '';
		for($i = 0 ; $i < 4; $i++) {
			$salt .= $characters[rand(0, $charactersLength - 1)];
		}
		return $salt;
	}
	
	//validates user name to see if the user has correct values
	function validate_username($field, $size) {
	if($field=="") return "no username entered <br>";
	else if (strlen($field) < $size) 
		return "usernames must be at least " . $size . " characters <br>";
	else if (preg_match("/[^a-zA-Z0-9_-]/", $field))
		return "only letters, numbers, - and _ in usernames<br>";
	return "";
}

//validates password to see if user has put in correct values
function validate_password($field, $size) {
			if($field=="") return "no password entered.<br> \n";
	else if (strlen($field) < $size) 
		return "password mumust be at least " . $size . " characters.\n";
	else if(!preg_match("/[a-z]/", $field) || 
			!preg_match("/[A-Z]/", $field)  ||
			!preg_match("/[0-9]/", $field) ||
			!preg_match("/[^\da-zA-Z]/",$field))
		return "password must contain lower and upper case letter, number, and a special character .\n";
	return "";
}
	
	
	
	
?>