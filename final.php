<?php
 require_once('signatures.php');
 require_once('authenticate.php');
 
$username = "";
$admin = "";

 if(isset($_SESSION['username'])) {
	 $username = $_SESSION['username'];
 }
 
 if(isset($_SESSION['admin'])) {
	 $admin = $_SESSION['admin'];
 }
 
 
 
 if(!checkSession()) {
	 echo "Please <a href='login.html'>click here</a> to log in.";
 } 
 
 //provides form for user to check files
 if( strcmp($username, "")!=0 && checkSession() ) {
	 echo "welcome " . $username;
	echo <<<_END
	<form method = "post" action = "final.php" enctype = 'multipart/form-data'>
	<input type = "file" name = "filename">
	<input type = "submit" value = "check file">		
	</form>
_END;


//provides 2 forms for the admin 
// one to check files 
// one to upload malware signatures
if(strcmp($admin,"Y")==0 && checkSession()) {
echo <<<_END
<script src = "validate.js"></script>
	<form method = "post" action = "login.php" enctype = 'multipart/form-data'  onsubmit="return validateMalware(this)">
	<input type = "file" name = "filename"> 
	<input type = "text" name = "malwareName">
	<input type = "submit" value = "upload malware">	
	</form>
_END;
}
destroy_session();

echo <<<_END
<a href="logout.php">Logout</a><br>
_END;


ini_set('session.gc_maxlifetime', 60 * 60 * 24);


 }
 
 //uses php function to check malware name
  $malName = "";
  if(isset($_POST['malwareName']))
	$malName = fix_string($_POST['malwareName']);
$fail = validate_malware($malName);
 
 function validate_malware($field) {
	if($field=="") return "no malware name entered <br>";
	else if (preg_match("/[^a-zA-Z0-9]/", $field))
		return "only letters, numbers in malware name<br>";
	return "";
}
	
	
	
	
	
	$con = mysqli_connect("localhost", 'root', '', 'db' );
	if (mysqli_connect_errno()) {
		echo "Failed to connect to MySQL: " . mysqli_connect_error();
	} 
		
		
		if($_FILES ) {
			$name = $_FILES['filename']['name'];
			move_uploaded_file($_FILES['filename']['tmp_name'],$name);
			switch($_FILES['filename']['type']) {
				case '':
					echo "no file";
				break;
				default : 
					//echo signature_hex($name, 20) . "<br>";
					echo checkFile($name, $con);
					//echo "<br>" . signature_hex($name,filesize($name));
				break;
			}
		}
	
	
	
	//compares file signature to signatures in database
	function checkFile($file, $con) {
		$checker = 0;
		$stringFile = signature_hex($file, filesize($file));
		$sql = "select * from common_signatures";
		$res = mysqli_query($con,$sql);
			while($row = mysqli_fetch_assoc($res)) {
				$commonSignature= $row['signature'];
				$pos = strpos($stringFile, $commonSignature);
				if($pos!==false) {
					echo "file infected by " . $row['malware'];
					$checker++;
				} 
			}
			if($checker ==0 ) {
				echo "file is safe";
			}
	}
	
	//checks session 
	function checkSession() {
		if(isset($_SESSION['username'])) {
			if($_SESSION['ip'] !=$_SERVER['REMOTE_ADDR'])  {
				return false;
			}
			if($_SESSION['ua']!=$_SERVER['HTTP_USER_AGENT']) {
				return false;
			}
		
			if($_SESSION['check']!= hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'] )) {
				return false;
			}
		}
		return true;
	}
	
	//destroys the session
	function destroy_session() {
			$_SESSION = array();
			setcookie(session_name(),'',time()-2592000, '/');
			session_destroy();
				
		}
	
	
	
	

?>